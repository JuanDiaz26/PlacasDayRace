<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cronómetro TV SPORT PRO (Remoto)</title>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@600;700&family=Roboto:wght@700;900&display=swap" rel="stylesheet">
    <style>
        /* --- COLORES OFICIALES --- */
        :root { --verde: #257E77; --verde-oscuro: #1b5e59; --naranja: #EF5B2B; --blanco: #ffffff; --negro-trans: rgba(0,0,0,0.85); }
        
        body { 
            background-color: rgba(0, 0, 0, 0.01); 
            margin: 0; padding: 0; overflow: hidden; height: 100vh; width: 100vw; 
            font-family: 'Roboto', sans-serif; 
            
            /* --- FIX VISIBILIDAD --- */
            opacity: 1;
            transition: opacity 0.5s ease-in-out; 
        }
        
        /* Clase para ocultar todo */
        body.oculto {
            opacity: 0 !important;
        }

        #pantalla-transmision { position: absolute; bottom: 30px; left: 30px; right: 30px; display: flex; justify-content: space-between; align-items: flex-end; pointer-events: none; }
        #lista-parciales { display: flex; flex-direction: column; gap: 5px; min-width: 200px; pointer-events: auto; transform: skewX(-10deg); }
        .fila-parcial { font-size: 20px; color: var(--blanco); background: linear-gradient(90deg, var(--negro-trans) 0%, rgba(0,0,0,0) 100%); padding: 6px 20px; border-left: 6px solid var(--naranja); box-shadow: 2px 2px 0px rgba(0,0,0,0.3); animation: entrarIzquierda 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; align-items: center; }
        .fila-parcial span { transform: skewX(10deg); }
        .fila-final { background: linear-gradient(90deg, #b71c1c 0%, rgba(183, 28, 28, 0) 100%); border-left: 6px solid #ffeb3b; color: #ffeb3b; }
        .distancia { color: #ccc; margin-right: 15px; font-weight: 700; font-size: 16px; text-transform: uppercase; width: 60px; }
        .tiempo-parcial { font-weight: 900; letter-spacing: 1px; font-variant-numeric: tabular-nums; }
        #contenedor-reloj { pointer-events: auto; transform: skewX(-10deg); box-shadow: 4px 4px 10px rgba(0,0,0,0.5); transition: transform 0.1s; }
        #caja-tiempo { background: linear-gradient(135deg, var(--verde) 0%, var(--verde-oscuro) 100%); padding: 5px 30px; display: flex; align-items: baseline; justify-content: center; border-top: 2px solid rgba(255,255,255,0.3); border-left: 2px solid rgba(255,255,255,0.3); }
        #barra-deco { height: 8px; background-color: var(--naranja); width: 100%; background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(0,0,0,0.2) 5px, rgba(0,0,0,0.2) 10px); }
        #numeros-reloj { color: white; font-family: 'Roboto', sans-serif; font-weight: 900; font-size: 52px; line-height: 1; text-shadow: 3px 3px 0 rgba(0,0,0,0.4); font-variant-numeric: tabular-nums; transform: skewX(10deg); display: flex; align-items: baseline; }
        #milisegundos { font-size: 32px; color: #a7ffeb; margin-left: 2px; }
        @keyframes entrarIzquierda { from { opacity: 0; transform: translateX(-30px) skewX(-10deg); } to { opacity: 1; transform: translateX(0) skewX(-10deg); } }
    </style>
</head>
<body>

    <div id="pantalla-transmision">
        <div id="lista-parciales"></div>
        <div id="contenedor-reloj">
            <div id="caja-tiempo">
                <div id="numeros-reloj">
                    <span id="min-sec">00:00</span>
                    <span id="milisegundos">.00</span>
                </div>
            </div>
            <div id="barra-deco"></div>
        </div>
    </div>

    <script>
        const hitos = ["400m", "800m", "1200m", "1600m", "2000m", "2400m"];
        let indiceHito = 0;
        let startTime, tInterval;
        let running = false;
        let distanciaRealDeLaCarrera = "FINAL"; // Valor por defecto
        let ultimoComandoID = 0; 

        const displayMinSec = document.getElementById('min-sec');
        const displayMili = document.getElementById('milisegundos');
        const listaParciales = document.getElementById('lista-parciales');
        const numerosReloj = document.getElementById('numeros-reloj');

        // --- 1. LEER DISTANCIA (AJUSTADO PARA "M") ---
        async function leerDistancia() {
            try {
                const r = await fetch('datos.json?nocache=' + Date.now()); 
                const d = await r.json();
                if (d.distancia) {
                    // Limpieza total: 1200 METROS -> 1200M
                    let texto = d.distancia.toUpperCase(); // Todo a mayusculas
                    texto = texto.replace("METROS", "M").replace("MTS", "M"); // Reemplazo palabras
                    texto = texto.replace(/\s/g, ""); // Borro espacios (1200 M -> 1200M)
                    distanciaRealDeLaCarrera = texto;
                }
            } catch (e) {}
        }

        // --- 2. LEER COMANDOS ---
        async function escucharComandos() {
            try {
                const response = await fetch('comando_reloj.json?nocache=' + Date.now());
                const data = await response.json();
                
                if (data.id && data.id !== ultimoComandoID) {
                    ultimoComandoID = data.id; 
                    ejecutarAccion(data.accion);
                }
            } catch (e) {}
        }

        function ejecutarAccion(accion) {
            console.log("Comando recibido:", accion);
            if (accion === "START") startTimer();
            if (accion === "STOP") stopTimer();
            if (accion === "RESET") resetTimer();
            if (accion === "PARCIAL") agregarParcial();
            if (accion === "FINALIZAR") finalizarCarrera();
            
            // --- FIX VISIBILIDAD ---
            if (accion === "OCULTAR") {
                document.body.classList.add('oculto');
            }
            if (accion === "MOSTRAR") {
                document.body.classList.remove('oculto');
            }
        }

        // --- FUNCIONES DEL RELOJ ---
        function startTimer() {
            if(!running){
                if(displayMinSec.innerHTML === "00:00" && displayMili.innerHTML === ".00") {
                     startTime = new Date().getTime();
                } else {
                    let partes = displayMinSec.innerHTML.split(":");
                    let msActuales = (parseInt(partes[0])*60000) + (parseInt(partes[1])*1000) + (parseInt(displayMili.innerHTML.replace(".",""))*10);
                    startTime = new Date().getTime() - msActuales;
                }
                tInterval = setInterval(getShowTime, 10);
                running = true;
                numerosReloj.style.color = "#fff"; 
            }
        }

        function stopTimer() {
            if (running){
                clearInterval(tInterval);
                running = false;
                numerosReloj.style.color = "#ffeb3b"; 
            }
        }

        function resetTimer() {
            clearInterval(tInterval);
            running = false;
            displayMinSec.innerHTML = "00:00";
            displayMili.innerHTML = ".00";
            listaParciales.innerHTML = "";
            indiceHito = 0;
            numerosReloj.style.color = "#fff";
        }

        function getShowTime(){
            let updatedTime = new Date().getTime();
            let difference = updatedTime - startTime;
            let minutes = Math.floor((difference % (1000 * 60 * 60)) / (1000 * 60));
            let seconds = Math.floor((difference % (1000 * 60)) / 1000);
            let milliseconds = Math.floor((difference % 1000) / 10);
            
            minutes = (minutes < 10) ? "0" + minutes : minutes;
            seconds = (seconds < 10) ? "0" + seconds : seconds;
            milliseconds = (milliseconds < 10) ? "0" + milliseconds : milliseconds;
            
            displayMinSec.innerHTML = minutes + ':' + seconds;
            displayMili.innerHTML = '.' + milliseconds;
        }

        function agregarParcial() {
            if (running) {
                let tiempoFoto = displayMinSec.innerHTML + displayMili.innerHTML;
                let etiqueta = hitos[indiceHito] ? hitos[indiceHito] : "P.";
                let nuevoRenglon = document.createElement("div");
                nuevoRenglon.className = "fila-parcial";
                nuevoRenglon.innerHTML = `<span><span class="distancia">${etiqueta}</span><span class="tiempo-parcial">${tiempoFoto}</span></span>`;
                listaParciales.appendChild(nuevoRenglon);
                indiceHito++;
            }
        }

        function finalizarCarrera() {
            if (running) {
                stopTimer();
                let tiempoFinalTexto = displayMinSec.innerHTML + displayMili.innerHTML;
                let etiquetaFinal = distanciaRealDeLaCarrera; // Aquí ya viene corregido como "1200M"
                let nuevoRenglon = document.createElement("div");
                nuevoRenglon.className = "fila-parcial fila-final"; 
                nuevoRenglon.innerHTML = `<span><span class="distancia">${etiquetaFinal}</span><span class="tiempo-parcial">${tiempoFinalTexto}</span></span>`;
                listaParciales.appendChild(nuevoRenglon);
            }
        }

        setInterval(leerDistancia, 2000); 
        setInterval(escucharComandos, 100); 

    </script>
</body>
</html>